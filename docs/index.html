<html>

<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src='https://code.jquery.com/jquery-3.3.1.min.js'
    integrity='sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=' crossorigin='anonymous'></script>
  <script src="https://sdk-cdn.mypurecloud.com/javascript/55.0.0/purecloud-platform-client-v2.min.js"></script>
</head>

<body>
  <div id="mainDiv" class="row row-no-gutters" style="margin: 25px">
    
    <div id = "divArchitectFlow" hidden>
    <label>Flow:</label>
    <select onchange="getArchitectFlows()" style="width:auto" id="architectFlow">
    </select>
  </div>

    <div id="divFlow" hidden>
      <label>Select Flow Name:</label>
      <select style="width:auto" id="flowNames" onchange="changeOptions()">
      </select>
    </div>
  </div>
</body>

</html>


<script>
  const clientId = '83d37bf5-e050-47bf-9937-0314b259c9c4';
  const redirectUri = window.location.href;


  // Set purecloud objects
  // const platformClient = require('purecloud-platform-client-v2');
  const platformClient = require('platformClient');
  const client = platformClient.ApiClient.instance;
  const architectApi = new platformClient.ArchitectApi();
  const oAuthApi = new platformClient.OAuthApi();

  

  // Set PureCloud settings
  client.setEnvironment('mypurecloud.com');

  // cache purecloud credentials to browser
  // client.setPersistSettings(true, 'test_app');

  //Authenticate with Purecloud
  $(document).ready(() => {
    client.loginImplicitGrant(clientId, redirectUri)
      .then(() => {
        console.log('Logged in');
        let token = client.authData.accessToken;
        $.get('http://localhost:3000/getFlowTypes', (flowType) => {
            createArchitectflow(flowType);
        
        })
        // send token to body
        // $.post('http://localhost:3000/gettoken', {
        //   token: token
        // });
      })

      .catch((err) => console.error(err));

  })

  // Create dynamic architect flow
  function createArchitectflow(flowType) {
    let flow = Object.keys(flowType);
    
    flow.forEach(function(flowType) {

    let flowTypeName = document.getElementById("architectFlow");
    let flowOptions = document.createElement("option");
    let temporaryFlow = flowType.split(/(?=[A-Z])/).join(" ");
    flowOptions.text = temporaryFlow.toUpperCase();
    flowOptions.value = flowType;
    flowTypeName.add(flowOptions);
    showArchitectFlowDropdown()
    });


  }

  function showArchitectFlowDropdown() {

  let divShowArchitectFlow = document.getElementById("divArchitectFlow");
  divShowArchitectFlow.style.display = "block";

  }


  function getArchitectFlows() {

    let selectedFlow = document.getElementById("architectFlow").value;

    let opts = {
      type: [selectedFlow],
      pageNumber: 1,
      pageSize: 1000

    };

    architectApi.getFlows(opts)
      .then((getFlowsdata) => {
        console.log(`getFlows success! data: ${JSON.stringify(getFlowsdata, null, 2)}`);
        populateDropdown(getFlowsdata);
      })
      .catch((err) => {
        console.log('There was a failure calling getFlows');
        console.error(err);
      });

  }

  // Populate dropdown list
  function populateDropdown(getFlowsdata) {

    document.getElementById("flowNames").innerHTML = "";

    // Convert array to map to access values inside the array
    let mapSelectedFlow = new Map(Object.entries(getFlowsdata));

    console.log("Map selected flow:" + JSON.stringify(mapSelectedFlow));

    // Store values of entities object to a variable
    let entities = mapSelectedFlow.get('entities');

    console.log("entities:" + JSON.stringify(entities));

    // Call function createoptions
    entities.forEach(createOptions);
  }

  function changeOptions() {

    let flows = document.getElementById("flowNames");
    let value = flows.options[flows.selectedIndex].value;
    let flowInfoFlowType = document.getElementById("architectFlow");
    let architectFlowValue = flowInfoFlowType.options[flowInfoFlowType.selectedIndex].value;
    
    console.log("architect flow value:" + architectFlowValue);

    console.log("Selected flow ID:" + value);
    // send token to body
    $.post('http://localhost:3000/getflowid', {
          flowid: value,
          flowInfoFlowType : architectFlowValue
        });

  }

  // Function to create options
  function createOptions(item) {

    let name = document.getElementById("flowNames");
    let option = document.createElement("option");
    option.text = item.name;
    option.value = item.id;
    name.add(option);
    showDropdown();

  }

  function showDropdown() {

    let divShow = document.getElementById("divFlow");
    divShow.style.display = "block";

  }


</script>